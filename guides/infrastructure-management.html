<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Infrastructure management | Kargo</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="https://s3.eu-central-1.amazonaws.com/kalisioscope/kargo/kargo-icon-64x64.png">
    <link rel="manifest" href="/kargo/manifest.json">
    <meta name="description" content="A Docker based solution to deploy Geospatial Services">
    
    <link rel="preload" href="/kargo/assets/css/0.styles.21f892e9.css" as="style"><link rel="preload" href="/kargo/assets/js/app.ccf7bffd.js" as="script"><link rel="preload" href="/kargo/assets/js/3.2a46a756.js" as="script"><link rel="preload" href="/kargo/assets/js/19.5d84ca90.js" as="script"><link rel="preload" href="/kargo/assets/js/4.1b74af09.js" as="script"><link rel="prefetch" href="/kargo/assets/js/10.ab06285d.js"><link rel="prefetch" href="/kargo/assets/js/11.64147753.js"><link rel="prefetch" href="/kargo/assets/js/12.32088f54.js"><link rel="prefetch" href="/kargo/assets/js/13.27dc4b94.js"><link rel="prefetch" href="/kargo/assets/js/14.fef6b623.js"><link rel="prefetch" href="/kargo/assets/js/15.8f6428ca.js"><link rel="prefetch" href="/kargo/assets/js/16.c407c2f1.js"><link rel="prefetch" href="/kargo/assets/js/17.ff63ab84.js"><link rel="prefetch" href="/kargo/assets/js/18.d5f0e9d8.js"><link rel="prefetch" href="/kargo/assets/js/2.aadf217f.js"><link rel="prefetch" href="/kargo/assets/js/20.ce2d0630.js"><link rel="prefetch" href="/kargo/assets/js/21.45a784ad.js"><link rel="prefetch" href="/kargo/assets/js/22.23faa706.js"><link rel="prefetch" href="/kargo/assets/js/23.9c8fd307.js"><link rel="prefetch" href="/kargo/assets/js/24.0e69f356.js"><link rel="prefetch" href="/kargo/assets/js/25.543069e9.js"><link rel="prefetch" href="/kargo/assets/js/26.15cc4a34.js"><link rel="prefetch" href="/kargo/assets/js/27.eba4c86a.js"><link rel="prefetch" href="/kargo/assets/js/28.a352e9d2.js"><link rel="prefetch" href="/kargo/assets/js/29.93903859.js"><link rel="prefetch" href="/kargo/assets/js/30.fa740c23.js"><link rel="prefetch" href="/kargo/assets/js/31.607edf94.js"><link rel="prefetch" href="/kargo/assets/js/32.ae881e8d.js"><link rel="prefetch" href="/kargo/assets/js/33.fbd3300b.js"><link rel="prefetch" href="/kargo/assets/js/34.27810eb7.js"><link rel="prefetch" href="/kargo/assets/js/5.08369b04.js"><link rel="prefetch" href="/kargo/assets/js/6.ef3c43be.js"><link rel="prefetch" href="/kargo/assets/js/7.24c688a2.js"><link rel="prefetch" href="/kargo/assets/js/8.92991761.js"><link rel="prefetch" href="/kargo/assets/js/9.1eff0c26.js">
    <link rel="stylesheet" href="/kargo/assets/css/0.styles.21f892e9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kargo/" class="home-link router-link-active"><!----> <span class="site-name">Kargo</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kargo/about/introduction.html" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/kargo/guides/understanding-kargo.html" class="nav-link">
  Guides
</a></div><div class="nav-item"><a href="/kargo/reference/environment.html" class="nav-link">
  Reference
</a></div><div class="nav-item"><a href="/kargo/tips/using-gdal.html" class="nav-link">
  Tips
</a></div><div class="nav-item"><a href="https://github.com/kalisio/kargo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kargo/about/introduction.html" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/kargo/guides/understanding-kargo.html" class="nav-link">
  Guides
</a></div><div class="nav-item"><a href="/kargo/reference/environment.html" class="nav-link">
  Reference
</a></div><div class="nav-item"><a href="/kargo/tips/using-gdal.html" class="nav-link">
  Tips
</a></div><div class="nav-item"><a href="https://github.com/kalisio/kargo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <p align="center"><a href="https://kalisio.com"><img src="https://s3.eu-central-1.amazonaws.com/kalisioscope/kalisio/kalisio-logo-black-256x84.png"></a> <br> <!----></p> <ul class="sidebar-links"><li><a href="/kargo/guides/understanding-kargo.html" class="sidebar-link">Understanding Kargo</a></li><li><a href="/kargo/guides/getting-started.html" class="sidebar-link">Getting Started</a></li><li><a href="/kargo/guides/advanced-usage.html" class="sidebar-link">Advanced usage</a></li><li><a href="/kargo/guides/infrastructure-management.html" aria-current="page" class="active sidebar-link">Infrastructure management</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#the-kaptain-script" class="sidebar-link">The kaptain script</a></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#sample-infrastructure-definition" class="sidebar-link">Sample infrastructure definition</a></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#sample-provision-configs-chart" class="sidebar-link">Sample provision-configs chart</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#namespace-secret-yaml" class="sidebar-link">namespace-secret.yaml</a></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#namespace-configmap-yaml" class="sidebar-link">namespace-configmap.yaml</a></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#rclone-config-secret-yaml" class="sidebar-link">rclone-config-secret.yaml</a></li></ul></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#kaptain-s-hooks" class="sidebar-link">Kaptain's hooks</a></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#embedding-the-kaptain-script" class="sidebar-link">Embedding the kaptain script</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#cloning-the-infrastructure-xyz-project" class="sidebar-link">Cloning the infrastructure-xyz project</a></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#pulling-changes-in-the-infrastructure-xyz-project" class="sidebar-link">Pulling changes in the infrastructure-xyz project</a></li><li class="sidebar-sub-header"><a href="/kargo/guides/infrastructure-management.html#updating-the-kargo-submodule" class="sidebar-link">Updating the kargo submodule</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="infrastructure-management"><a href="#infrastructure-management" class="header-anchor">#</a> Infrastructure management</h1> <p>In this guide, basic knowledge of <a href="https://helm.sh" target="_blank" rel="noopener noreferrer">Helm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> releases and <a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener noreferrer">Kubernetes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> concepts are assumed.</p> <p>Infrastructures are managed using the <strong>kaptain</strong> script. This script is a bash script wrapping calls to <a href="https://helmfile.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Helmfile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> adding policies we found interesting.</p> <p><strong>Helmfile</strong> is a tool that sits on top of <strong>Helm</strong>, it allows to manage a set of Helm releases through it's <code>helmfile.yaml</code> configuration file. With this set of tools (Helmfile, Helm and Kubernetes), it becomes possible to setup a source repository where configuration for a whole infrastructure is checked under revision. Managing what's deployed on the cluster, configuration options and every other infrastructure aspect now goes through editing of the proper yaml file (or template).</p> <h2 id="the-kaptain-script"><a href="#the-kaptain-script" class="header-anchor">#</a> The kaptain script</h2> <p>The <strong>kaptain</strong> script provides the following commands:</p> <ul><li><em>config</em> to install only the Helm releases that are labelled as <code>config</code> for the infrastructure</li> <li><em>install</em> to install all the releases required by the infrastructure.</li> <li><em>uninstall</em> to undo what <em>install</em> did (minus the config releases).</li> <li><em>provision</em> to setup and trigger the job that will provision data on the infrastructure (this is optional)</li> <li><em>diff</em> to diff what's about to be installed through the <em>install</em> command with what's currently deployed on the infrastructure</li></ul> <p>Internally, <strong>kaptain</strong> calls helmfile with the proper set of options.</p> <ul><li><em>config</em> will ask helmfile to deploy all releases labelled as <code>action: config</code> in the <code>helmfile.yaml</code></li> <li><em>install</em> will ask helmfile to deploy all releases labelled as <code>action: install</code> in the <code>helmfile.yaml</code>. Usually there's a direct dependency between releases labelled for install and those labelled for config, meaning it will first deploy configs, and then proceed to install.</li> <li><em>provision</em> will ask helmfile to deploy all releases labelles as <code>action: provision</code>.</li></ul> <p>Theses <a href="https://helmfile.readthedocs.io/en/latest/#labels-overview" target="_blank" rel="noopener noreferrer">labels<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are the only requirements of the <code>helmfile.yaml</code> to be usable with <strong>kaptain</strong>.</p> <h2 id="sample-infrastructure-definition"><a href="#sample-infrastructure-definition" class="header-anchor">#</a> Sample infrastructure definition</h2> <p>Let's start with a folder where we'll define our infrastructure. The first file to add is <code>helmfile.yaml</code>.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># Declare required helm repositories here</span>
<span class="token key atrule">repositories</span><span class="token punctuation">:</span>
  <span class="token comment"># Bitnami</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bitnami
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//charts.bitnami.com/bitnami
  <span class="token comment"># Others ...</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//charts.foo.bar/blah
</code></pre></div><p>We often have two additional yaml files along the helmfile :</p> <ul><li><code>global.yaml</code> is where we put a bunch of infrastructure scope variables, we want them to be available in Helm and Helmfile templates.</li> <li><code>secret.yaml</code> is where we put a bunch of infrastructure scope secrets, we usually deploy a secret named as the infrastructure where we pack all those values.</li></ul> <p>In order to use values from <code>global.yaml</code> in our helmfile templates, we usually add the following to the <code>helmfile.yaml</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># Values listed here will be available in _helmfile_ templates</span>
<span class="token key atrule">values</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> global.yaml
  <span class="token comment"># This one is defined by kaptain, as it is required, helmfile will stop if it's undefined</span>
  <span class="token punctuation">-</span> <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> requiredEnv &quot;KAPTAIN_NAMESPACE&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>And to use those values from helm templates, we usually factorize configuration using the following :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># This factorize reusable definitions</span>
<span class="token key atrule">templates</span><span class="token punctuation">:</span>
  <span class="token key atrule">install</span><span class="token punctuation">:</span> <span class="token important">&amp;install</span>
    <span class="token comment"># namespace where to deploy</span>
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">values</span><span class="token punctuation">:</span>
       <span class="token comment"># where to lookup release values.yaml (.gotmpl mean that helmfile must run it throught template evaluation)</span>
      <span class="token punctuation">-</span> configs/<span class="token punctuation">{</span><span class="token punctuation">{</span>`<span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>`<span class="token punctuation">}</span><span class="token punctuation">}</span>/values.yaml.gotmpl
      <span class="token comment"># also add values from global.yaml in Helm values</span>
      <span class="token punctuation">-</span> global.yaml
    <span class="token key atrule">set</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> global.secret
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token comment"># selector label</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> install
    <span class="token comment"># install _after_ provision-configs</span>
    <span class="token key atrule">needs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> provision<span class="token punctuation">-</span>configs
</code></pre></div><p>This block defines a set of default configuration options for releases we'll label using <code>action: install</code> :</p> <ul><li>the namespace the release will be deployed into: <code>namespace: { { .Values.namespace } }</code>. This is a Helmfile template, and values are looked up from what we defined with the <code>values</code> block earlier.</li> <li>where to lookup release values. From our <code>global.yaml</code> file and from a file named <code>values.yaml.gotmpl</code> located in a subfolder named as the release in the <code>configs</code> folder.</li> <li>it also defines a special value named <code>global.secret</code> we use in our <a href="https://github.com/kalisio/kargo/charts" target="_blank" rel="noopener noreferrer">kargo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> charts.</li> <li>it defines the release label(s). Here it's <code>action: install</code> which means it's a release that'll get deployed as part of <code>kaptain install</code></li> <li>a direct dependency on the <code>provision-configs</code> release.</li></ul> <p>With all this in place, we can start adding releases to deploy in our <code>helmfile.yaml</code> :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">releases</span><span class="token punctuation">:</span>
  <span class="token comment"># This chart is _always_ installed first</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> provision<span class="token punctuation">-</span>configs
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> provision<span class="token punctuation">-</span>configs
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">values</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> global.yaml
      <span class="token punctuation">-</span> secret.yaml
      <span class="token punctuation">-</span> configs/<span class="token punctuation">{</span><span class="token punctuation">{</span>`<span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>`<span class="token punctuation">}</span><span class="token punctuation">}</span>/values.yaml.gotmpl
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> config
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> bitnami/redis
    <span class="token key atrule">version</span><span class="token punctuation">:</span> ~15.7.0
    <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*install</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>commander
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> kalisio/redis<span class="token punctuation">-</span>commander
    <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*install</span>
</code></pre></div><p><code>redis</code> and <code>redis-commander</code> are releases sharing the <code>install</code> definitions we added earlier.</p> <p><code>provision-configs</code> is a local chart labelled using <code>action: config</code>. It'll be installed first (because <code>install</code> labelled releases depend on it). We usually use this chart to deploy a bunch of infrastructure scope kubernetes manifests such as the rclone config secret, config maps for charts that don't generate their own and instead rely on user generated objects, the infrastructure secret built from the <code>secret.yaml</code>file, various cronjobs ...</p> <h2 id="sample-provision-configs-chart"><a href="#sample-provision-configs-chart" class="header-anchor">#</a> Sample provision-configs chart</h2> <p>This chart can be used to deploy infrastructure config objects before other releases are installed. This is where you can add all the custom kubernetes manifests you may need. In the previous sample, the <code>provision-configs</code> release was defined as :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">releases</span><span class="token punctuation">:</span>
  <span class="token comment"># This chart is _always_ installed first</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> provision<span class="token punctuation">-</span>configs
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> provision<span class="token punctuation">-</span>configs
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">values</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> global.yaml
      <span class="token punctuation">-</span> secret.yaml
      <span class="token punctuation">-</span> configs/<span class="token punctuation">{</span><span class="token punctuation">{</span>`<span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>`<span class="token punctuation">}</span><span class="token punctuation">}</span>/values.yaml.gotmpl
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> config
</code></pre></div><p>This states that we'll deploy the chart in the same namespace as other charts, that content from <code>global.yaml</code> and <code>secret.yaml</code> will be available to Helm templates, along with <code>provision-config's</code> values.yaml. It also defines the <code>action: config</code> label which mean this will be deployed as part of <code>kaptain config</code>.</p> <p>We ususally find at least the following manifests in it's <code>template</code> folder :</p> <h3 id="namespace-secret-yaml"><a href="#namespace-secret-yaml" class="header-anchor">#</a> namespace-secret.yaml</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> toYaml .Values.secret <span class="token punctuation">|</span> nindent 2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>This will contain all the secrets from the <code>secret.yaml</code> file.</p> <h3 id="namespace-configmap-yaml"><a href="#namespace-configmap-yaml" class="header-anchor">#</a> namespace-configmap.yaml</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Namespace <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.configKeys <span class="token punctuation">|</span> toYaml <span class="token punctuation">|</span> indent 2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>This will embed everything defined under <code>configKeys</code> in the release values.yaml</p> <h3 id="rclone-config-secret-yaml"><a href="#rclone-config-secret-yaml" class="header-anchor">#</a> rclone-config-secret.yaml</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rclone<span class="token punctuation">-</span>config
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token key atrule">rclone.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> (.Files.Get &quot;.kaptain/rclone.conf&quot;) <span class="token punctuation">|</span> indent 4 <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>This will create a secret from the <code>rclone.conf</code> file.</p> <h2 id="kaptain-s-hooks"><a href="#kaptain-s-hooks" class="header-anchor">#</a> Kaptain's hooks</h2> <p>Before calling helmfile with the proper set of options, the <strong>kaptain</strong> script runs user defined hooks. These are defined in the <code>hooks.sh</code> file. This file is sourced from the main <strong>kaptain</strong> script with the hook name as first parameter. The following environment variables are available in the hooks:</p> <ul><li><strong>KAPTAIN_NAMESPACE</strong>: the namespace we're deploying releases into</li> <li><strong>KAPTAIN_NAMESPACE_DIRECTORY</strong>: the directory where the helmfile.yaml is located</li> <li><strong>KAPTAIN_WORKING_DIRECTORY</strong>: the directory from where we started the kaptain script</li></ul> <p>Hooks are defined as <code>pre-$ACTION</code> and <code>post-$ACTION</code> where <code>$ACTION</code> is one of the <strong>kaptain</strong>'s command (<em>install</em>, <em>config</em>, ...). There's an additional hook, named <code>make-config</code> which is called prior to <em>install</em>, <em>provision</em>, <em>config</em> and <em>diff</em> commands. This hook is commonly used to setup local charts, such as <code>provision-configs</code>. It is used for example to copy config files that must be turned into configmaps into the <code>provision-configs</code> hierarchy. It is required because Helm won't allow files from outside the chart to be read during the template evaluation.</p> <p>This <code>make-config</code> hook is what makes possible to put the content of the <code>rclone.conf</code> file in the <a href="/kargo/guides/#rclone-config-secret.yaml">rclone config secret</a> sample. The template uses <code>(.Files.Get &quot;.kaptain/rclone.conf&quot;)</code> to read the file's content, but Helm will only agree to read files included in the chart it is currently processing (here, the <code>provision-config</code>chart).</p> <p>Here's an example of <code>hooks.sh</code>:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># The name of the hook being run</span>
<span class="token assign-left variable">HOOK</span><span class="token operator">=</span><span class="token variable">$1</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$HOOK</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;make-config&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token comment"># These are used in the namespace-configmap</span>
    <span class="token builtin class-name">export</span> <span class="token assign-left variable">REPO_REVISION</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> -C $KAPTAIN_WORKING_DIRECTORY describe --tags --always --dirty<span class="token operator">=</span>+<span class="token variable">)</span></span>
    <span class="token builtin class-name">export</span> <span class="token assign-left variable">REPO_BRANCH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> -C $KAPTAIN_WORKING_DIRECTORY rev-parse --abbrev-ref HEAD<span class="token variable">)</span></span>

    embed_config express-gateway
    rclone_config tileservergl
    embed_config mapserver
    embed_config mapcache
    embed_config weacast
    embed_config kano
    <span class="token comment"># add gdal-wmts sources to both mapserver &amp; mapcache</span>
    rclone copy <span class="token string">&quot;<span class="token variable">$KAPTAIN_WORKING_DIRECTORY</span>/configs/gdal-wmts/&quot;</span> <span class="token string">&quot;<span class="token variable">$KAPTAIN_NAMESPACE_DIRECTORY</span>/provision-configs/.kaptain/mapserver&quot;</span>
    rclone copy <span class="token string">&quot;<span class="token variable">$KAPTAIN_WORKING_DIRECTORY</span>/configs/gdal-wmts/&quot;</span> <span class="token string">&quot;<span class="token variable">$KAPTAIN_NAMESPACE_DIRECTORY</span>/provision-configs/.kaptain/mapcache&quot;</span>
<span class="token keyword">fi</span>
</code></pre></div><p><code>embed_config</code>, <code>rclone_config</code> are helper functions defined in the <strong>kaptain</strong> script.</p> <p>Those hooks could probably be replaced by <a href="https://helmfile.readthedocs.io/en/latest/#hooks" target="_blank" rel="noopener noreferrer">helmfile hooks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> but this is still work in progress ...</p> <h2 id="embedding-the-kaptain-script"><a href="#embedding-the-kaptain-script" class="header-anchor">#</a> Embedding the kaptain script</h2> <p>Kaptain is often embedded in infrastructure projects using a git submodule, here's a quick HOWTO cheatsheet:</p> <p>Consider the following project's structure :</p> <div class="language- extra-class"><pre class="language-text"><code>+ infrastructure-xyz
  - global.yaml
  - secret.yaml
  - helmfile.yaml
  + scripts
    - install.sh      # convenience script calling kaptain
    - diff.sh         # convenience script calling kaptain
    - ...
  + kargo             # git submodule
    + scripts
      - kaptain.sh
</code></pre></div><h3 id="cloning-the-infrastructure-xyz-project"><a href="#cloning-the-infrastructure-xyz-project" class="header-anchor">#</a> Cloning the infrastructure-xyz project</h3> <p>Just clone like you're used to adding the <code>--recurse-submodules</code> flag.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone --recurse-submodules
</code></pre></div><p>If you cloned the project and forgot the <code>--recurse-submodules</code> flag, read the next section.</p> <h3 id="pulling-changes-in-the-infrastructure-xyz-project"><a href="#pulling-changes-in-the-infrastructure-xyz-project" class="header-anchor">#</a> Pulling changes in the infrastructure-xyz project</h3> <p>Since the kargo folder is a git submodule, pull using <code>--recurse-submodules</code> flag. This will ensure you also pull the kargo's version that's associated with the infrastructure-xyz project.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> pull --recurse-submodules
</code></pre></div><p>You can make this the default by defining the <code>submodule.recurse</code>option to true in your repository.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> config submodule.recurse  <span class="token boolean">true</span>
</code></pre></div><h3 id="updating-the-kargo-submodule"><a href="#updating-the-kargo-submodule" class="header-anchor">#</a> Updating the kargo submodule</h3> <p>If you want to change the version the kargo submodule points to then <code>cd</code> into the kargo folder and pull the desired commit, or tag, or branch. Once done, <code>cd</code> back to the root of your project and <code>commit</code> the kargo folder. This will record the kargo version your project depends on.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> kargo
<span class="token function">git</span> pull v1.9
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">git</span> <span class="token function">add</span> kargo
<span class="token function">git</span> commit -m <span class="token string">&quot;Bumped kargo submodule to v1.9&quot;</span>
<span class="token function">git</span> push
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/kargo/guides/advanced-usage.html" class="prev">
        Advanced usage
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/kargo/assets/js/app.ccf7bffd.js" defer></script><script src="/kargo/assets/js/3.2a46a756.js" defer></script><script src="/kargo/assets/js/19.5d84ca90.js" defer></script><script src="/kargo/assets/js/4.1b74af09.js" defer></script>
  </body>
</html>
