version: '3.5'

  gravitee-gateway:
    image: graviteeio/gateway:latest
    environment:
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
      - gravitee_ratelimit_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
    deploy:
      labels:
        - "traefik.docker.network=${DOCKER_NETWORK}"
        - "traefik.backend=gravitee-gateway"        
        - "traefik.enable=true"
        - "traefik.frontend.entryPoints=http,https"
        - "traefik.frontend.rule=Host:gravitee-api.${SUBDOMAIN}"
        - "traefik.port=8082"        
      replicas: 1
      placement:
        constraints:
         - node.role == manager       
      restart_policy:
        condition: on-failure
    networks:
      - kargo-network

  gravitee-portal:
    image: graviteeio/management-ui:latest
    environment:
      - MGMT_API_URL=https:\/\/apim.gravitee.io\/management\/
    deploy:
      labels:
        - "traefik.docker.network=${DOCKER_NETWORK}"
        - "traefik.backend=gravitee-portal"        
        - "traefik.enable=true"
        - "traefik.frontend.entryPoints=http,https"
        - "traefik.frontend.rule=Host:gravitee-portal.${SUBDOMAIN}"    
      replicas: 1
      placement:
        constraints:
         - node.role == manager       
      restart_policy:
        condition: on-failure
    networks:
      - kargo-network      

  gravitee-management:
    image: graviteeio/management-api:latest
    environment:
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
      - gravitee_ratelimit_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
      - gravitee_jwt_cookiepath=/management
      - gravitee_jwt_cookiesecure=true
      - gravitee_jwt_cookiedomain=apim.gravitee.io
    deploy:
      labels:
        - "traefik.docker.network=${DOCKER_NETWORK}"
        - "traefik.backend=gravitee-management"        
        - "traefik.enable=true"
        - "traefik.frontend.entryPoints=http,https"
        - "traefik.frontend.rule=Host:gravitee-management.${SUBDOMAIN}"
        - "traefik.port=8083"        
      replicas: 1
      placement:
        constraints:
         - node.role == manager       
      restart_policy:
        condition: on-failure
    networks:
      - kargo-network       


  