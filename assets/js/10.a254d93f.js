(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{175:function(t,e,s){"use strict";s.r(e);var a=s(0),r=Object(a.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._m(9),t._v(" "),t._m(10),t._v(" "),s("p",[t._v("On the manager node, clone the repository in your home directory:")]),t._v(" "),t._m(11),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),s("p",[t._v("To ensure the volume is permanently mounted (even on reboot), you should prefer to:")]),t._v(" "),t._m(15),t._v(" "),t._m(16),t._m(17),t._v(" "),t._m(18),t._m(19),t._v(" "),s("p",[t._v("It is up to you to copy your data to the different nodes. You must have to keep in mind that these data will have to be accessible by the services that you want to deploy.")]),t._v(" "),s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("Looking for data ?")]),t._v(" "),s("p",[t._v("We can provide datasets from different sources such as public catalogs and those of our partners such as "),s("a",{attrs:{href:"https://openmaptiles.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenMapTiles"),s("OutboundLink")],1),t._v(", "),s("a",{attrs:{href:"https://www.planetobserver.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("PlanetObserver"),s("OutboundLink")],1),t._v(". Do bot hesitate to contact us !")])]),t._v(" "),t._m(20),t._v(" "),s("p",[t._v("Once you have copy the datasets to the different nodes, you need to add some labels to the nodes that can be used to specify constraints when deploying the services.")]),t._v(" "),s("p",[t._v("In our case, we need to add the following labels:")]),t._v(" "),t._m(21),s("p",[t._v("Check your node labels mapping:")]),t._v(" "),t._m(22)])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"prepare-the-infrastructure"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prepare-the-infrastructure","aria-hidden":"true"}},[this._v("#")]),this._v(" Prepare the infrastructure")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"install-the-prerequisites"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-the-prerequisites","aria-hidden":"true"}},[this._v("#")]),this._v(" Install the prerequisites")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"install-a-local-registry"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-a-local-registry","aria-hidden":"true"}},[this._v("#")]),this._v(" Install a local Registry")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Some of the services proposed by "),e("strong",[this._v("Kargo")]),this._v(" need to be built before you can deploy it. For this reason, it is necessary to have a local Registry on the Manager node to store the images.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("To install it you can run the command "),e("code",[this._v("docker stack deploy -c registry.yml registry")]),this._v(" where the Compose file "),e("code",[this._v("registry.yml")]),this._v(" has the following content:")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("version: '3.5'\n\nservices:\n  registry:\n    image: registry:2\n    ports:\n      - 5000:5000\n    networks:\n      - swarm-network\n    deploy:\n      replicas: 1\n      placement:\n        constraints:\n          - node.role == manager\n\nnetworks:\n  swarm-network:\n    name: <swarm network>\n    external: true\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"install-sshfs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-sshfs","aria-hidden":"true"}},[this._v("#")]),this._v(" Install SSHFS")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("p",[t._v("As we will see later, "),s("strong",[t._v("SSHFS")]),t._v(" is used to share the "),s("strong",[t._v("Kargo")]),t._v(" configuration among the nodes. You need to install "),s("strong",[t._v("SSHFS")]),t._v(" on each worker.\nTo install "),s("strong",[t._v("SSHFS")]),t._v(" you may run the following procedure:")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" sshfs\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Edit fuse conf to enable the allow_other option")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nano")]),t._v(" /etc/fuse.conf and uncomment the line\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#user_allow_other")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"install-kargo"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-kargo","aria-hidden":"true"}},[this._v("#")]),this._v(" Install kargo")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[this._v("Clone the "),e("strong",[this._v("Kargo")]),this._v(" repository")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[this._v("$git")]),this._v(" clone https://github.com/kalisio/kargo.git\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"2"}},[e("li",[this._v("Share the "),e("strong",[this._v("Kargo")]),this._v(" configuration with the workers.")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("On each worker, use "),e("code",[this._v("sshfs")]),this._v(" to share the "),e("code",[this._v("configs")]),this._v(" directory. The path to the shared directory must be the same on the workers as on the manager.")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /home/ubuntu/kargo/.kargo/configs\nsshfs ubuntu@"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("swam manager ip"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":/home/ubuntu/kargo/.kargo/configs /home/ubuntu/kargo/.kargo/configs -o IdentityFile"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/home/ubuntu/.ssh/ssh.pem -o allow_other\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[this._v("add the following line to your "),e("code",[this._v("/etc/fstab")]),this._v(" file:")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("sshfs#ubuntu@<manager_ip>:/home/ubuntu/kargo/.kargo/configs /home/ubuntu/kargo/.kargo/configs fuse auto,_netdev,port=22,user,allow_other,IdentityFile=/home/ubuntu.ssh/ssh.pem,reconnect 0 0\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"2"}},[e("li",[this._v("mount the volume using the command:")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[this._v("$sudo")]),this._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("mount")]),this._v(" -a\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"provision-the-data"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#provision-the-data","aria-hidden":"true"}},[this._v("#")]),this._v(" Provision the data")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"define-node-labels"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#define-node-labels","aria-hidden":"true"}},[this._v("#")]),this._v(" Define node labels")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# On worker-0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$docker")]),t._v(" node update --label-add tileservergl"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true jqtuxajexk18ypiylk6i6dv0q\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# On worker-1 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$docker")]),t._v(" node update --label-add weacast"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true wfr5hwhfd5413p2ql9hwitbkw\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# On worker-2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$docker")]),t._v(" node update --label-add mongodb"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true 8980x3d76x1r7kxoa7h5lzob8\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$docker")]),t._v(" node update --label-add postgis"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true 8980x3d76x1r7kxoa7h5lzob8\n")])])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$docker")]),t._v(" node "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" -q "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("xargs")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker node inspect -f "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{{ .ID }} [{{ .Description.Hostname }}]: {{ .Spec.Labels }}'")]),t._v("\njqtuxajexk18ypiylk6i6dv0q "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("worker-0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tileservergl:true"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nx6tc2sqi99vp106icwf2nmyp0 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("manager"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nwfr5hwhfd5413p2ql9hwitbkw "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("worker-1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("weacast:true"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n8980x3d76x1r7kxoa7h5lzob8 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("worker-2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mongodb:true postgis:true"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])])}],!1,null,null,null);r.options.__file="prepare-the-infrastructure.md";e.default=r.exports}}]);